<?xml version="1.0"?>
<launch>

  <arg name="dist" default="0"/>
  <arg name="id" default="0"/>
  <arg name="cam" default="$(find ccmslam)/conf/euroc_rect.yaml"/>
  <arg name="camera_calibration_file_path" default = "$(find coxgraph)/config/euroc/euroc_camchain.yaml"/>
  <arg name="bag_file" default="MH_01_easy.bag"/>
  <arg name="clock" default="false"/>
  <arg name="play_speed" default="1"/>
  <arg name="skip_seconds" default="0"/>

  <group ns="ccmslam">

    <node pkg="ccmslam" type="ccmslamClientNode" name="ccmslamClientNode$(arg id)" args="$(find ccmslam)/conf/ORBvoc.txt $(arg cam)" output="screen" >

      <!-- ++++++++++++++++++++++++++++++++++++++++++++++ -->
      <!-- Agent Specific Params - !!!MUST BE ADJUSTED!!! -->

      <param name="~FrameId" type="string" value="odomC$(arg id)" />
      <param name="~ClientId" type="int" value="$(arg id)" />

      <param name="~do_rectify" value="false"/>
      <param name="~Sensor" value="Stereo"/>
      <param name="~TopicNameCamSub" type="string" value="/rect_$(arg id)/first/image" />
      <param name="~RightTopicName" type="string" value="/rect_$(arg id)/second/image" />

      <param name="~MapInTopicName" type="string" value="MapOutServer$(arg id)" unless="$(arg dist)" />
      <param name="~MapInTopicName" type="string" value="MapOutServer$(arg id)Disturbed" if="$(arg dist)" />

      <param name="server_mode" value="false"/>
      <param name="odom_frame" value="map_$(arg id)"/>
      <param name="imu_frame" value="firefly_$(arg id)/base_link"/>
      <param name="sensor_frame" value="firefly_$(arg id)/vi_sensor"/>
      <param name="tf_pub_period_ms" value="10"/>
      <rosparam file="$(find coxgraph)/config/euroc/imu_to_camera.yaml" command="load"/>
    </node>

  </group>

  <!-- Stereo image rectification. -->
  <node name="dense_stereo_node_$(arg id)" pkg="image_undistort" type="dense_stereo_node" output="screen">

    <param name="input_camera_info_from_ros_params" value = "true"/>
    <param name="first_camera_namespace" value="cam0"/>
    <param name="second_camera_namespace" value="cam1"/>
    <param name="scale" value="1.0"/>
    <param name="process_every_nth_frame" value="1"/>

    <rosparam file="$(arg camera_calibration_file_path)"/>
    <param name="cam0/rostopic" value="/cam0_$(arg id)/image_raw"/>
    <param name="cam1/rostopic" value="/cam1_$(arg id)/image_raw"/>
    <param name="rename_input_frame" value="true"/>
    <param name="input_frame" value="firefly_$(arg id)/vi_sensor"/>

    <remap from="raw/first/image" to="/cam0_$(arg id)/image_raw"/>
    <remap from="raw/second/image" to="/cam1_$(arg id)/image_raw"/>

    <remap from="rect/first/image" to="/rect_$(arg id)/first/image"/>
    <remap from="rect/second/image" to="/rect_$(arg id)/second/image"/>

    <remap from="pointcloud" to="/pointcloud_$(arg id)"/>
  </node>

  <node if="$(arg clock)" pkg="rosbag" type="play" name="player_$(arg id)" args="$(arg bag_file) -r $(arg play_speed) -s $(arg skip_seconds) --clock /cam0/image_raw:=/cam0_$(arg id)/image_raw /cam1/image_raw:=/cam1_$(arg id)/image_raw /cam0/camera_info:=/cam0_$(arg id)/camera_info /cam1/camera_info:=/cam1_$(arg id)/camera_info"/>
  <node unless="$(arg clock)" pkg="rosbag" type="play" name="player_$(arg id)" args="$(arg bag_file) -d 5 -r $(arg play_speed) -s $(arg skip_seconds) /cam0/image_raw:=/cam0_$(arg id)/image_raw /cam1/image_raw:=/cam1_$(arg id)/image_raw /cam0/camera_info:=/cam0_$(arg id)/camera_info /cam1/camera_info:=/cam1_$(arg id)/camera_info"/>

</launch>

